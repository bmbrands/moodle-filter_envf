{"version":3,"sources":["../src/userprofileform.js"],"names":["define","$","Str","Fragment","Templates","Ajax","Notification","UserForm","formelement","contextid","userid","formelementcontainer","on","submitFormAjax","bind","validUserFields","prototype","e","preventDefault","changeEvent","document","createEvent","initEvent","find","each","index","element","dispatchEvent","invalid","merge","length","first","focus","formData","JSON","stringify","serialize","userform","loadFragment","then","form","js","replaceNodeContents","children","data","formDataCombined","serializeArray","reduce","acc","item","includes","name","value","call","methodname","args","userdata","done","handleFormSubmissionResponse","fail","handleFormSubmissionFailure","get_string","str","addNotification","message","type","init","ready","classmarker","currentform"],"mappings":"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","sourcesContent":["/**\n * Add the form to the page\n *\n * @module      filter_envf/userprofileform.js\n * @package     filter_envf\n * @copyright   CALL Learning - Laurent David <laurent@call-learning.fr>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'core/str',\n        'core/fragment',\n        'core/templates',\n        'core/ajax',\n        'core/notification'\n    ],\n    function ($,\n              Str,\n              Fragment,\n              Templates,\n              Ajax,\n              Notification\n    ) {\n        var UserForm = function (formelement, contextid, userid) {\n            this.formelementcontainer = formelement;\n            this.contextid = contextid;\n            this.userid = userid;\n            formelement.on('submit', 'form', this.submitFormAjax.bind(this));\n        };\n\n        var validUserFields = [\n            'id',\n            'username',\n            'auth',\n            'suspended',\n            'firstname',\n            'lastname',\n            'email',\n            'maildisplay',\n            'city',\n            'country',\n            'timezone',\n            'description',\n            'userpicture',\n            'firstnamephonetic',\n            'lastnamephonetic',\n            'middlename',\n            'alternatename',\n            'interests',\n            'url',\n            'icq',\n            'skype',\n            'aim',\n            'yahoo',\n            'msn',\n            'idnumber',\n            'institution',\n            'department',\n            'phone1',\n            'phone2',\n            'address',\n            'lang',\n            'calendartype',\n            'theme',\n            'mailformat',\n            'customfields',\n            'preferences',\n        ];\n        /**\n         * Private method\n         *\n         * @method submitFormAjax\n         * @private\n         * @param {Event} e Form submission event.\n         */\n        UserForm.prototype.submitFormAjax = function (e) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            var changeEvent = document.createEvent('HTMLEvents');\n            changeEvent.initEvent('change', true, true);\n\n            // Prompt all inputs to run their validation functions.\n            // Normally this would happen when the form is submitted, but\n            // since we aren't submitting the form normally we need to run client side\n            // validation.\n            var formelement = $(this.formelementcontainer).find('form');\n            formelement.find(':input').each(function (index, element) {\n                element.dispatchEvent(changeEvent);\n            });\n\n            // Now the change events have run, see if there are any \"invalid\" form fields.\n            var invalid = $.merge(\n                formelement.find('[aria-invalid=\"true\"]'),\n                formelement.find('.error')\n            );\n\n            // If we found invalid fields, focus on the first one and do not submit via ajax.\n            if (invalid.length) {\n                invalid.first().focus();\n                return;\n            }\n            var formelementcontainer = this.formelementcontainer;\n            var formData = JSON.stringify(formelement.serialize());\n            var params = {\n                'jsonformdata': formData\n            };\n            var userform = this;\n            // Reload the form to check for errors.\n            Fragment.loadFragment('filter_envf', 'userprofile_form',\n                this.contextid,\n                params)\n                .then(function (form, js) {\n                    Templates.replaceNodeContents(formelementcontainer, form, js);\n                    if (formelementcontainer.children('.upf-userformvalidated').data('validated')) {\n                        var formDataCombined = $(formelementcontainer.find('form'))\n                            .serializeArray()\n                            .reduce(function (acc, item) {\n                                if (validUserFields.includes(item.name)) {\n                                    acc[item.name] = item.value;\n                                }\n                                return acc;\n                            }, {});\n                        if (typeof formDataCombined['newpassword'] !== undefined)  {\n                            delete formDataCombined['newpassword'];\n                        }\n                        if (typeof formDataCombined['password'] !== undefined)  {\n                            delete formDataCombined['password'];\n                        }\n                        // Now we can continue and send the data...\n                        Ajax.call([{\n                            methodname: 'filter_envf_update_user',\n                            args: {userdata: formDataCombined},\n                            done: userform.handleFormSubmissionResponse.bind(userform, formDataCombined),\n                            fail: userform.handleFormSubmissionFailure.bind(userform, formDataCombined)\n                        }]);\n                    }\n                });\n            // Convert all the form elements values to a serialised string.\n\n        };\n        /**\n         * Private method\n         *\n         * @method handleFormSubmissionResponse\n         * @private\n         * @param {Event} e Form submission success.\n         */\n        UserForm.prototype.handleFormSubmissionResponse = function (data) {\n            Str.get_string('userupdated', 'filter_envf', data).done(\n                (str) => {\n                    Notification.addNotification({\n                        message: str,\n                        type: \"info\"\n                    });\n                }\n            );\n        };\n        /**\n         * Private method\n         *\n         * @method handleFormSubmissionFailure\n         * @private\n         * @param {Event} e Form submission failure.\n         */\n        UserForm.prototype.handleFormSubmissionFailure = function () {\n\n\n        };\n        return {\n            init: function (args) {\n                $(document).ready(function () {\n                    $('.' + args.classmarker).each(function () {\n                        var userid = $(this).data('userid');\n                        var contextid = $(this).data('contextid');\n                        var params = {};\n                        var currentform = $(this);\n                        Fragment.loadFragment('filter_envf', 'userprofile_form', contextid, params)\n                            .then(function (form, js) {\n                                Templates.replaceNodeContents(currentform, form, js);\n                                new UserForm(currentform, contextid, userid); // Bind the form.\n                            });\n                    });\n                });\n            }\n        };\n    }\n);"],"file":"userprofileform.min.js"}